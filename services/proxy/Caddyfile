:80 {
  # In development, allow HTTP access to API endpoints
  handle /api/* {
    reverse_proxy gateway:8080
  }
  # Redirect other requests to HTTPS
  handle {
    redir https://{host}{uri} permanent
  }
}

localhost:443, {$VITE_HOSTNAME}:443 {
  tls internal
  log foo
  
  # API routes (must come before frontend routes)
  handle /api/* {
    reverse_proxy gateway:8080
  }
  
  # WebSocket notifications (reverse proxy direct vers la gateway)
  handle /ws* {
    reverse_proxy gateway:8080
  }
  
  handle /adminer/* {
    reverse_proxy adminer:8080
  }

  # Frontend routes (catch-all, must come last)
  handle {
    # Frontend main route
    handle /* {
      reverse_proxy frontend:5173
    }
  }

}
